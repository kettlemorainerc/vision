plugins {
    id 'java'
    id 'application'
    id "edu.wpi.first.GradleRIO" version "2020.3.2"
}

jar {
    from { configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) } }
    manifest edu.wpi.first.gradlerio.GradleRIOPlugin.javaManifest("org.usfirst.frc.team2077.video.Main")
}

def targetConfiguration = "aimingFEThree2020";
targetCompatibility = (JavaVersion.VERSION_11)
sourceCompatibility = (JavaVersion.VERSION_11)

task copyVideoData(type: Copy) {
    from("VIDEO_DATA") {
        include "*"
    }
    into "$buildDir${File.separator}tmp${File.separator}jniExtractDir${File.separator}VIDEO_DATA"
}

task saveVideoData(type: Copy) {
    from("$buildDir${File.separator}tmp${File.separator}jniExtractDir${File.separator}VIDEO_DATA") {
        include '*'
    }
    into "VIDEO_DATA"
}

tasks.withType(JavaExec) {
    dependsOn tasks.copyVideoData
    finalizedBy(tasks.saveVideoData)
    workingDir "$buildDir${File.separator}tmp${File.separator}jniExtractDir"
    argsString(targetConfiguration)
    systemProperty 'java.library.path', "${System.getProperty("java.library.path")}${File.pathSeparator}$buildDir${File.separator}tmp${File.separator}jniExtractDir"
}

repositories {
    mavenCentral()
    jcenter()
    mavenLocal()
    maven {
        url 'http://maven.icm.edu.pl/artifactory/repo/'
    }
}

run {
    shouldRunAfter tasks.extractTestJNI
    systemProperty 'java.library.path', "${System.getProperty("java.library.path")}${File.pathSeparator}$buildDir${File.separator}tmp${File.separator}jniExtractDir"

    main = "org.usfirst.frc.team2077.video.Main"
}

dependencies {
    implementation wpi.deps.wpilib()
    nativeZip wpi.deps.wpilibJni(wpi.platforms.roborio)
    nativeDesktopZip wpi.deps.wpilibJni(wpi.platforms.desktop)

    implementation wpi.deps.vendor.java()
    nativeZip wpi.deps.vendor.jni(wpi.platforms.roborio)
    nativeDesktopZip wpi.deps.vendor.jni(wpi.platforms.desktop)

    implementation group: 'com.jcraft', name: 'jsch', version: '0.1.55'
    implementation group: 'org.freedesktop.gstreamer', name: 'gst1-java-core', version: '1.4.0'
    implementation group: 'org.freedesktop.gstreamer', name: 'gst1-java-swing', version: '0.9.0'
    implementation group: 'org.opencv', name: 'openCVLibrary', version: '3.4.0'
    implementation group: 'net.java.dev.jna', name: 'jna', version: '5.6.0'
    implementation group: 'net.java.dev.jna', name: 'jna', version: '5.6.0'
    implementation files("network-tables${File.separator}ntcore-java-4.0.0.jar")
    implementation files("network-tables${File.separator}ntcore-jni-4.0.0-all.jar")
    implementation files("network-tables${File.separator}wpiutil-java-3.0.0.jar")

}

task startNetwork(type: JavaExec) {
    classpath = sourceSets.main.runtimeClasspath
    main = "org.usfirst.frc.team2077.vision.NTMain"

    dependsOn(tasks.build)
}